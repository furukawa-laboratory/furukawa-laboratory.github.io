(function(){queue().defer(d3.text,"./data/w.txt").defer(d3.csv,"./data/k_star1.csv").defer(d3.csv,"./data/k_star2.csv").defer(d3.csv,"./data/k_star3.csv").await(function(g,F,G,B,H){function w(b,a,e,k){if(0===b)return m[a][e][k];if(1===b)return m[e][a][k];if(2===b)return m[e][k][a]}function da(){p.forEach(function(b,a){if(h[a].flag){var e=h[a].unit%10,k=Math.floor(h[a].unit/10);b.selectAll(".cpHexagon").each(function(b){b.i===e&&b.j===k&&R(b,a)})}})}function R(b,a){p[a].select(".select").transition().duration(30).attr("cx",
b.x).attr("cy",b.y).attr("r",f).style("opacity",1);h[a].unit=10*b.j+b.i}function W(b){0===E[b]?(cpHex[b].transition().style("opacity",0),I(b)):1===E[b]&&(cpHex[b].transition().style("opacity",1),X(b))}function S(b){for(var a=0;3>a;a++)b!==a&&(0===E[a]?I(a):1===E[a]&&X(a))}function X(b){var a=h[y[b].other1].flag,e=h[y[b].other2].flag,k=h[y[b].other1].unit,C=h[y[b].other2].unit;1===E[b]&&cpHex[b].style("fill",function(f,c){var z=0;if(a&&e)z=w(b,c,k,C);else if(!a&&e){for(var g=0;120>g;g++)z+=w(b,c,g,
C);z/=120}else if(a&&!e){for(g=0;120>g;g++)z+=w(b,c,k,g);z/=120}else if(!a&&!e){for(g=0;120>g;g++)for(var h=0;120>h;h++)z+=w(b,c,g,h);z/=14400}return O(z)})}function I(b){ea(b);Y[b].style("fill",function(a,e){return Z(t[b][e])})}function ea(b){var a,e,k=[],C=0,c=0,f=0,g=h[y[b].other1].flag,r=h[y[b].other2].flag;if(g||r||!T[b]){for(a=0;19>a;a++)for(e=0;23>e;e++)if(0!==a%2||0!==e%2){if(3===e%4){var m=10*Math.floor(e/2)+Math.floor(a/2);var p=10*Math.ceil(e/2)+Math.ceil(a/2)}else m=10*Math.ceil(e/2)+
Math.floor(a/2),p=10*Math.floor(e/2)+Math.ceil(a/2);var x=b,q=0,v=h[y[x].other1].flag,u=h[y[x].other2].flag,l=h[y[x].other1].unit,A=h[y[x].other2].unit;if(v&&u)q=Math.pow(w(x,m,l,A)-w(x,p,l,A),2);else if(!v&&u)for(v=0;120>v;v++)q+=Math.pow(w(x,m,v,A)-w(x,p,v,A),2);else if(v&&!u)for(v=0;120>v;v++)q+=Math.pow(w(x,m,l,v)-w(x,p,l,v),2);else if(!v&&!u)for(l=0;120>l;l++)for(A=0;120>A;A++)q+=Math.pow(w(x,m,l,A)-w(x,p,l,A),2);d=Math.sqrt(q);k[19*e+a]=d;C+=d;c+=d*d;f+=1}for(a=0;19>a;a++)for(e=0;23>e;e++)if(0===
a%2&&0===e%2){for(n=d=count=0;6>n;n++)pos=aa(a,e,n),-1!==pos&&(d+=k[pos],count+=1);d/=count;k[19*e+a]=d;C+=d;c+=d*d;f+=1}C/=f;c=Math.sqrt(c/f-Math.pow(C,2));for(a=0;19>a;a++)for(e=0;23>e;e++)if(0===a%2&&0===e%2)t[b][19*e+a]=k[19*e+a];else{for(n=d=count=0;6>n;n++)pos=aa(a,e,n),-1!==pos&&(d+=k[pos],count+=1);d=(d+k[19*e+a])/(count+1);t[b][19*e+a]=d}for(a=0;437>a;a++)t[b][a]=(t[b][a]-C)/(4*c)+.5,0>t[b][a]&&(t[b][a]=0),1<t[b][a]&&(t[b][a]=1);if(!g&&!r&&!T[b]){for(a=0;437>a;a++)ba[b][a]=t[b][a];T[b]=!0}}else for(a=
0;437>a;a++)t[b][a]=ba[b][a]}function aa(b,a,e){switch(e){case 0:var k=b+(1===a%4||2===a%4?1:0);var c=a-1;break;case 1:k=b+1;c=a;break;case 2:k=b+(2===a%4||3===a%4?1:0);c=a+1;break;case 3:k=b-1+(2===a%4||3===a%4?1:0);c=a+1;break;case 4:k=b-1;c=a;break;case 5:k=b-1+(1===a%4||2===a%4?1:0),c=a-1}return 0>k||19<=k||0>c||23<=c?-1:19*c+k}for(var m=F.replace(/\r/g,'').replace(/\n+$/g,"").split("\n\n"),c=0;c<m.length;c++)for(m[c]=m[c].split("\n"),g=0;g<m[c].length;g++)for(m[c][g]=m[c][g].split(" "),F=0;F<m[c][g].length;F++)m[c][g][F]=
parseFloat(m[c][g][F]);var ca=[G,B,H],q=(window.innerWidth-16)/3,u=window.innerHeight-47,f=d3.min([q/(9.5*Math.sqrt(3)+4),u/20.5]),l=f/2,J=2*f,U=2*f,K=2*f,V=2*f;q=K+V+f*Math.sqrt(3)*9.5;u=J+U+33*f/2;var L=d3.hexbin().radius(f),M=d3.hexbin().radius(l),P=[],D=[];for(c=0;12>c;c++)for(g=0;10>g;g++)P.push([f*g*1.75,f*c*1.5]),D.push({x:f*(g+c%2*.5)*Math.sqrt(3),y:f*c*1.5,unit:10*c+g});G=[];B=[];for(c=0;23>c;c++)for(g=0;19>g;g++)G.push([l*(g+Math.abs((c+2)%4-2)/2)*Math.sqrt(3),l*c*1.5]),B.push({x:l*(g+Math.abs((c+
2)%4-2)/2)*Math.sqrt(3),y:l*c*1.5});d3.interpolateHslLong=function(b,a){b=d3.hsl(b);a=d3.hsl(a);var e=b.h,c=b.s,f=b.l,g=a.h-e,h=a.s-c,z=a.l-f;return function(a){return d3.hsl(e+g*a,c+h*a,f+z*a).rgb().toString()}};var O=d3.scale.linear().domain([1,3,5]).range(["blue","white","red"]),Z=d3.interpolateHslLong("blue","red"),r=d3.select("body").select("div").selectAll("div").append("svg").attr("width",q).attr("height",u).append("g").attr("transform","translate("+K+","+J+")");g=d3.select("#map1").select("svg").select("g");
H=d3.select("#map2").select("svg").select("g");B=d3.select("#map3").select("svg").select("g");var p=[g,H,B];r.selectAll(".uHexagon").data(M(G)).enter().append("path").attr("class","uHexagon").attr("d",M.hexagon()).attr("transform",function(b){return"translate("+b.x+","+b.y+")"}).style("stroke","black").style("stroke-width",.5);var Y=[],t=[];for(c=0;3>c;c++)t.push([]),Y[c]=p[c].selectAll(".uHexagon").style("fill",function(b,a){0===c&&(t[c][a]=b.y/u);1===c&&(t[c][a]=Math.sqrt(b.x*b.y)/Math.sqrt(q*u));
2===c&&(t[c][a]=b.x/q);return Z(t[c][a])});r.selectAll(".cpHexagon").data(L(P)).enter().append("path").attr("class","cpHexagon").attr("d",L.hexagon()).attr("transform",function(b){return"translate("+b.x+","+b.y+")"}).style("opacity",1).style("stroke","black").style("stroke-width",.5);G=g.selectAll(".cpHexagon").style("fill",function(b,a){return O(a/120)});H=H.selectAll(".cpHexagon").style("fill",function(b,a){return O((120-a)/120)});B=B.selectAll(".cpHexagon").style("fill",function(b,a){return O(b.x/
q)});cpHex=[G,H,B];r.selectAll(".dot").data(D).enter().append("circle").attr("class","dot").attr("cx",function(b){return b.x}).attr("cy",function(b){return b.y}).attr("r","1px").style("pointer-events","none");r.each(function(b,a){d3.select(this).selectAll(".dot").data(ca[a],function(a){return a.unit}).attr("r","4px").style("stroke","white").style("stroke-width","1px")});r.each(function(b,a){d3.select(this).selectAll(".label").data(ca[a]).enter().append("text").attr("class","label").attr("text-anchor",
"middle").attr("x",function(a){return D[a.unit].x}).attr("y",function(a){return D[a.unit].y+.6*f}).attr("font-family","Meiryo UI").attr("font-weight","bolder").attr("font-size",.6*f).attr("fill","#000").attr("stroke-width",5).attr("stroke-linejoin","round").attr("stroke","#FFF").attr("paint-order","stroke").text(function(a){return a.label}).style("pointer-events","none")});r.each(function(b,a){p[a].selectAll(".label").each(function(){var b=this,c=this.getBoundingClientRect();p[a].selectAll(".label").each(function(){if(b!=
this){var a=this.getBoundingClientRect(),e=a.top<c.bottom&&c.top<a.bottom;a.left<c.right&&c.left<a.right&&e&&(a=d3.min([c.right-a.left,a.right-c.left])+.5*f,d3.select(b).attr("transform","translate("+-a/2+",0)"),d3.select(this).attr("transform","translate("+a/2+",0)"))}})})});d3.selectAll("svg").each(function(b,a){var c=this.getBoundingClientRect();p[a].selectAll(".label").each(function(){var a=this.getBoundingClientRect(),b=a.left-c.left;0>b&&d3.select(this).attr("transform","translate("+-b+", 0)");
b=c.right-a.right;0>b&&d3.select(this).attr("transform","translate("+b+", 0)")})});var E=[1,1,1],y=[{other1:1,other2:2},{other1:0,other2:2},{other1:0,other2:1}],h=[{unit:0,flag:!1},{unit:0,flag:!1},{unit:0,flag:!1}];d3.selectAll(".uradio").on("change",function(b,a){E[a]=0;W(a)}).attr("font-size",.6*f);d3.selectAll(".cpradio").on("change",function(b,a){E[a]=1;W(a)}).attr("font-size",.6*f);var Q=!1,N=!1;d3.select("body").on("mouseup",function(){Q=!1});d3.select("body").select("div").selectAll("div").on("mouseleave",
function(){Q=!1});d3.select("body").on("mousedown",function(){Q=!0;d3.event.preventDefault()});r.each(function(b,a){d3.select(this).selectAll(".cpHexagon").on("mouseover",function(b){Q&&h[a].flag&&(R(b,a),S(a),d3.event.preventDefault())})});r.each(function(b,a){d3.select(this).selectAll(".cpHexagon").on("mousedown",function(b){h[a].flag?h[a].unit===10*b.j+b.i?N=!0:(N=!1,R(b,a)):(N=!1,h[a].flag=!0,p[a].selectAll(".select").remove(),p[a].append("circle").attr("class","select").attr("cx",b.x).attr("cy",
b.y).style("fill","none").style("stroke","green").style("stroke-width",3).style("opacity",0).attr("r",3*f).transition().attr("r",f).style("opacity",1),h[a].unit=10*b.j+b.i);S(a);d3.event.preventDefault()}).on("click",function(b){h[a].flag&&h[a].unit===10*b.j+b.i&&N&&(N=!1,h[a].flag=!1,p[a].selectAll(".select").transition().attr("r",3*f).style("opacity",0).remove(),S(a),d3.event.preventDefault())})});d3.select(window).on("resize",function(b){q=(window.innerWidth-16)/3;u=window.innerHeight-47;f=d3.min([q/
(9.5*Math.sqrt(3)+4),u/20.5]);l=f/2;J=2*f;U=2*f;K=2*f;V=2*f;q=K+V+f*Math.sqrt(3)*9.5;u=J+U+33*f/2;d3.select("body").select("div").selectAll("div").attr("width",q).attr("height",u);d3.select("body").select("div").selectAll("div").select("svg").attr("width",q).attr("height",u);L=d3.hexbin().radius(f);M=d3.hexbin().radius(l);for(b=0;12>b;b++)for(var a=0;10>a;a++)P[10*b+a]=[f*a*1.75,f*b*1.5],D[10*b+a]={x:f*(a+b%2*.5)*Math.sqrt(3),y:f*b*1.5};var c=[];for(b=0;23>b;b++)for(a=0;19>a;a++)c[19*b+a]=[l*(a+Math.abs((b+
2)%4-2)/2)*Math.sqrt(3),l*b*1.5];r.attr("transform","translate("+K+","+J+")");r.selectAll(".uHexagon").data(M(c)).attr("d",M.hexagon()).attr("transform",function(a){return"translate("+a.x+","+a.y+")"});r.selectAll(".cpHexagon").data(L(P)).attr("d",L.hexagon()).attr("transform",function(a){return"translate("+a.x+","+a.y+")"});r.selectAll(".dot").data(D).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y});da();r.each(function(a,b){d3.select(this).selectAll(".label").attr("x",function(a){return D[a.unit].x}).attr("y",
function(a){return D[a.unit].y+.6*f}).attr("font-size",.6*f)});r.each(function(a,b){p[b].selectAll(".label").each(function(){var a=this,c=this.getBoundingClientRect();p[b].selectAll(".label").each(function(){if(a!=this){var b=this.getBoundingClientRect(),e=b.top<c.bottom&&c.top<b.bottom;b.left<c.right&&c.left<b.right&&e&&(b=d3.min([c.right-b.left,b.right-c.left])+.5*f,d3.select(a).attr("transform","translate("+-b/2+",0)"),d3.select(this).attr("transform","translate("+b/2+",0)"))}})})});d3.selectAll("svg").each(function(a,
b){var c=this.getBoundingClientRect();p[b].selectAll(".label").each(function(){var a=this.getBoundingClientRect(),b=a.left-c.left;0>b&&d3.select(this).attr("transform","translate("+-b+", 0)");b=c.right-a.right;0>b&&d3.select(this).attr("transform","translate("+b+", 0)")})})});var ba=[[],[],[]],T=[!1,!1,!1];X(0);X(1);X(2)})})();