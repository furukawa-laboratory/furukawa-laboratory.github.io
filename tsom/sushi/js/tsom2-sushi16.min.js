(function(){queue().defer(d3.text,"./data/w.txt").defer(d3.csv,"./data/k_star1.csv").defer(d3.csv,"./data/k_star2.csv").defer(d3.text,"./data/wa.txt").defer(d3.csv,"./data/attr.csv").defer(d3.text,"./data/wl.txt").await(function(la,ca,da,ea,fa,P,ha){function Q(b){z=(window.innerWidth-16)/2;C=window.innerHeight-130;k=d3.max([d3.min([z/(19.5*Math.sqrt(3)+4),C/38.5]),13.5]);var a=k/2;z=k*(19.5*Math.sqrt(3)+4);C=38.5*k;d3.select("#map").selectAll("div").select("svg").attr("width",z).attr("height",C);
d3.select("#map").selectAll("div").select("svg").select("g").attr("transform","translate("+2*k+","+2*k+")");var c=d3.hexbin().radius(k),e=d3.hexbin().radius(a),f=[];q=[];for(var g=0;24>g;g++)for(var h=0;20>h;h++)f.push([k*h*1.75,k*g*1.5]),q.push({x:k*(h+g%2*.5)*Math.sqrt(3),y:k*g*1.5,unit:20*g+h});var m=[],l=[];for(g=0;47>g;g++)for(h=0;39>h;h++)m.push([a*(h+Math.abs((g+2)%4-2)/2)*Math.sqrt(3),a*g*1.5]),l.push({x:a*(h+Math.abs((g+2)%4-2)/2)*Math.sqrt(3),y:a*g*1.5});if(b){R=r.selectAll(".uHexagon").data(e(m)).enter().append("path").attr("class",
"uHexagon").style("stroke","black").style("stroke-width",.5).style("fill",function(a){return S(a.x/z)});T=r.selectAll(".cpHexagon").data(c(f)).enter().append("path").attr("class","cpHexagon").style("opacity",1).style("stroke","black").style("stroke-width",.5).style("fill",function(a){return J(a.x/z*5)});for(g=0;2>g;g++)U.push(r.filter(function(a,b){return b===g}).selectAll(".uHexagon")),w.push(r.filter(function(a,b){return b===g}).selectAll(".cpHexagon"));V=r.selectAll(".dot").data(q).enter().append("circle").attr("class",
"dot").attr("r","1px").style("pointer-events","none");r.each(function(a,b){d3.select(this).selectAll(".dot").data(p[b],function(a){return a.unit}).attr("r","4px").style("stroke","white").style("stroke-width","1px")});r.each(function(a,b){d3.select(this).selectAll(".label").data(p[b]).enter().append("text").attr("class","label").attr("text-anchor","middle").attr("font-family","Meiryo UI").attr("font-weight","bolder").attr("fill","#000").attr("stroke-width",k/10).attr("stroke","#FFF").attr("paint-order",
"stroke").attr("stroke-linejoin","round").text(function(a){return a.label}).style("pointer-events","none")})}R.data(e(m)).attr("d",function(a){return"M"+a.x+","+a.y+e.hexagon()});T.data(c(f)).attr("d",function(a){return"M"+a.x+","+a.y+c.hexagon()});V.data(q).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y});r.each(function(a,b){d3.select(this).selectAll(".label").attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("font-size",function(){if(0===b)return 2;if(1===
b)return 20})});D.forEach(function(a,b){a.on("tick",function(a){var c=.1*a.alpha;p[b].forEach(function(a,b){a.y+=(q[a.unit].y-a.y)*c;a.x+=(q[a.unit].x-a.x)*c});A[b].selectAll(".label").attr("x",function(a){return a.x}).attr("y",function(a){return a.y})})});D.forEach(function(a){a.start()});ia()}function K(b){0===l[b]?(w[b].transition().style("opacity",0),1===b&&!0===E&&(E=!1),W(b)):1===l[b]?(w[b].transition().style("opacity",1),1===b&&!0===E?X(b,0):B(b)):2===l[b]&&(w[b].transition().style("opacity",
1),1===b&&!0===E?X(b,0):B(b))}function L(b,a){A[a].select(".select").transition().duration(30).attr("cx",b.x).attr("cy",b.y).attr("r",k).style("opacity",1);m[a].unit=20*b.j+b.i}function ia(){A.forEach(function(b,a){if(m[a].flag){var c=m[a].unit%20,e=Math.floor(m[a].unit/20);b.selectAll(".cpHexagon").filter(function(a){return a.i===c&&a.j===e}).each(function(b){L(b,a)})}})}function M(b){1===b&&1===l[0]&&d3.select("#map1").select(".cpradio").property("checked",!0);0===b&&(E=!1);for(var a=0;2>a;a++)b!==
a&&(0===l[a]?W(a):1===l[a]?B(a):2===l[a]&&B(a))}function B(b){var a=m[(b+1)%2].flag,c=m[(b+1)%2].unit,e="";1===l[b]?e+="(\u7d76\u5bfe\u5024)":2===l[b]&&(e+="(\u76f8\u5bfe\u5024)");if(a){var f="";p[(b+1)%2].forEach(function(a,b){parseInt(a.unit)===c&&(""!==f&&(f+="/"),f+=a.label)});x[b].text(function(){""===f&&(f="unit"+c);return"\u7279\u5b9a\u306e"+F[(b+1)%2]+"("+f+")\u306e\u30b9\u30b3\u30a2"+e})}else x[b].text(function(){return F[(b+1)%2]+"\u306e\u5e73\u5747\u30b9\u30b3\u30a2"+e});if(1===l[b])w[b].style("fill",
function(e,g){if(a)var f=v(b,g,c);else{for(var h=f=0;480>h;h++)f+=v(b,g,h);f/=480}return J(f)});else if(2===l[b]){for(var g=0,h=0;480>h;h++){if(a)var k=v(b,h,c);else{for(var I=k=0;480>I;I++)k+=v(b,h,I);k/=480}g+=k}g/=480;w[b].style("fill",function(e,f){if(a)var h=v(b,f,c);else{for(var k=h=0;480>k;k++)h+=v(b,f,k);h/=480}return Y(h-g)})}}function X(b,a){if(0===b){x[b].text(function(){return"\u300c"+P[a].label+"\u300d\u306e\u5206\u5e03"});var c=d3.max(t,function(b,c){return b[a]}),e=d3.min(t,function(b,
c){return b[a]});Z=d3.scale.linear().domain([e,c]).range(["white","black"]);w[b].style("fill",function(b,c){return Z(t[c][a])})}else{var f="";1===l[b]?f+="(\u7d76\u5bfe\u5024)":2===l[b]&&(f+="(\u76f8\u5bfe\u5024)");x[b].text(function(){return"\u300c"+P[a].label+"\u300d\u306e\u5e73\u5747\u30b9\u30b3\u30a2"+f});w[b].style("fill",function(c,e){for(var f=0,g=0,h=0;480>h;h++)g+=t[h][a],f+=t[h][a]*y[h][e];if(1===l[b])return J(f/g);if(2===l[b])return Y(f/g-ja[e])})}}function W(b){ka(b);var a=m[(b+1)%2].unit;
if(m[(b+1)%2].flag){var c="";p[(b+1)%2].forEach(function(b,f){parseInt(b.unit)===a&&(""!==c&&(c+="/"),c+=b.label)});x[b].text(function(){""===c&&(c="unit"+a);return"\u7279\u5b9a\u306e"+F[(b+1)%2]+"("+c+")\u306b\u304a\u3051\u308b"+F[b]+"\u9593\u306e\u985e\u4f3c\u5ea6"})}else x[b].text(function(){return F[b]+"\u9593\u306e\u985e\u4f3c\u5ea6"});U[b].style("fill",function(a,c){return S(u[b][c])})}function ka(b){var a,c,e=[],f=0,g=0,h=0,k=m[(b+1)%2].flag;if(!k&&N[b])for(a=0;1833>a;a++)u[b][a]=aa[b][a];
else{for(a=0;39>a;a++)for(c=0;47>c;c++)if(0!==a%2||0!==c%2){if(3===c%4){var l=20*Math.floor(c/2)+Math.floor(a/2);var r=20*Math.ceil(c/2)+Math.ceil(a/2)}else l=20*Math.ceil(c/2)+Math.floor(a/2),r=20*Math.floor(c/2)+Math.ceil(a/2);var p=b,t=0,q=m[(p+1)%2].unit;if(m[(p+1)%2].flag)t=Math.pow(v(p,l,q)-v(p,r,q),2);else for(q=0;480>q;q++)t+=Math.pow(v(p,l,q)-v(p,r,q),2);d=Math.sqrt(t);e[39*c+a]=d;f+=d;g+=d*d;h+=1}for(a=0;39>a;a++)for(c=0;47>c;c++)if(0===a%2&&0===c%2){for(n=d=count=0;6>n;n++)pos=ba(a,c,n),
-1!==pos&&(d+=e[pos],count+=1);d/=count;e[39*c+a]=d;f+=d;g+=d*d;h+=1}f/=h;g=Math.sqrt(g/h-Math.pow(f,2));for(a=0;39>a;a++)for(c=0;47>c;c++)if(0===a%2&&0===c%2)u[b][39*c+a]=e[39*c+a];else{for(n=d=count=0;6>n;n++)pos=ba(a,c,n),-1!==pos&&(d+=e[pos],count+=1);d=(d+e[39*c+a])/(count+1);u[b][39*c+a]=d}for(a=0;1833>a;a++)u[b][a]=(u[b][a]-f)/(4*g)+.5,0>u[b][a]&&(u[b][a]=0),1<u[b][a]&&(u[b][a]=1);if(!k&&!N[b]){for(a=0;1833>a;a++)aa[b][a]=u[b][a];N[b]=!0}}}function v(b,a,c){if(0===b)return y[a][c];if(1===b)return y[c][a]}
function ba(b,a,c){switch(c){case 0:var e=b+(1===a%4||2===a%4?1:0);var f=a-1;break;case 1:e=b+1;f=a;break;case 2:e=b+(2===a%4||3===a%4?1:0);f=a+1;break;case 3:e=b-1+(2===a%4||3===a%4?1:0);f=a+1;break;case 4:e=b-1;f=a;break;case 5:e=b-1+(1===a%4||2===a%4?1:0),f=a-1}return 0>e||39<=e||0>f||47<=f?-1:39*f+e}var y=ca.replace(/\r/g,'').replace(/\n+$/g,"").split("\n");y.forEach(function(b,a){y[a]=b.split(" ");y[a].forEach(function(b,e){y[a][e]=parseFloat(y[a][e])})});var p=[da,ea],t=fa.replace(/\r/g,'').replace(/\n+$/g,"").split("\n");t.forEach(function(b,
a){t[a]=b.split(" ");t[a].forEach(function(b,e){t[a][e]=parseFloat(t[a][e])})});var ja=ha.replace(/\r/g,'').replace(/\n+$/g,"").split("\n"),E=!1,x=[];x[0]=d3.select("#map1").select(".message");x[1]=d3.select("#map2").select(".message");var F=["\u56de\u7b54\u8005","\u5bff\u53f8"],k,q=[],z,C;d3.interpolateHslLong=function(b,a){b=d3.hsl(b);a=d3.hsl(a);var c=b.h,e=b.s,f=b.l,g=a.h-c,h=a.s-e,k=a.l-f;return function(a){return d3.hsl(c+g*a,e+h*a,f+k*a).rgb().toString()}};for(var J=d3.scale.linear().domain([1,5.5,10]).range(["blue",
"white","red"]),Y=d3.scale.linear().domain([-.5,0,.5]).range(["blue","white","red"]),S=d3.interpolateHslLong("blue","red"),Z=d3.scale.linear().domain([1,5]).range(["white","black"]),r=d3.select("#map").selectAll("div.map").select("svg").append("g").append("g").attr("class","trans-t").append("g").attr("class","trans-r").append("g").attr("class","trans-s"),A=[],O=0;2>O;O++)A.push(r.filter(function(b,a){return a===O}));var w=[],U=[],N=[!1,!1],aa=[[],[]],u=[[],[]],T,R,V,l=[1,1],m=[{unit:0,flag:!1},{unit:0,
flag:!1}],D=[d3.layout.force(),d3.layout.force()];Q(!0);B(0);B(1);d3.select(window).on("resize",function(b){Q(!1)});p.forEach(function(b,a){p[a].forEach(function(b,e){p[a][e].x=q[b.unit].x;p[a][e].y=q[b.unit].y})});D.forEach(function(b,a){D[a]=d3.layout.force().nodes(p[a]).charge(.5*-k).gravity(.02).size([z-4*k,C-4*k])});D.forEach(function(b){b.start()});d3.selectAll(".uradio").on("change",function(b,a){l[a]=0;K(a)});d3.selectAll(".cpradio").on("change",function(b,a){l[a]=1;K(a)});d3.selectAll(".cpradior").on("change",
function(b,a){l[a]=2;K(a)});var H=!1,G=!1;d3.select("body").on("mouseup",function(){H=!1});d3.select("body").select("div").selectAll("div").on("mouseleave",function(){H=!1});d3.select("body").on("mousedown",function(){H=!0});r.each(function(b,a){d3.select(this).selectAll(".cpHexagon").on("mouseover",function(b){H&&m[a].flag&&(L(b,a),M(a),d3.event.preventDefault())})});r.each(function(b,a){d3.select(this).selectAll(".cpHexagon").on("mousedown",function(b){m[a].flag?m[a].unit===20*b.j+b.i?G=!0:(G=!1,
L(b,a)):(G=!1,m[a].flag=!0,A[a].selectAll(".select").remove(),A[a].append("circle").attr("class","select").attr("cx",b.x).attr("cy",b.y).style("fill","none").style("stroke","green").style("stroke-width",3).style("opacity",0).attr("r",3*k).transition().attr("r",k).style("opacity",1),m[a].unit=20*b.j+b.i);M(a);d3.event.preventDefault()}).on("click",function(b){m[a].flag&&m[a].unit===20*b.j+b.i&&G&&(G=!1,m[a].flag=!1,A[a].selectAll(".select").transition().attr("r",3*k).style("opacity",0).remove(),M(a),
d3.event.preventDefault())})})})})();