(function(){queue().defer(d3.text,"./data/w.txt").defer(d3.text,"./data/wa.txt").defer(d3.csv,"./data/l1.csv").defer(d3.csv,"./data/l2.csv").defer(d3.csv,"./data/la.csv").defer(d3.json,"./data/parameter.json").await(function(h,w,Z,ra,sa,ta,K){function aa(a,b){0===b?(B[1]=0,ba[1]=0,L[1]=2):(B[1]=1,ba[1]=1,L[1]=0);0===b&&(2===k[2]&&2===k[2]&&(k[2]=1,p.filter(function(a,b){return 2===b}).selectAll("input").property("checked",function(a,b){return 1===b})),d3.select("#mm2ecp").property("disabled",!0));
1===b&&m[0].flag&&!m[1].flag&&d3.select("#mm2ecp").property("disabled",!1);P(1);C()}function C(){for(var a=0;3>a;a++)ca[a].text(function(b){b="";0===B[a]?b+="SushiData ":1===B[a]&&(b+="AttrData ");m[L[a]].flag?b=b+"Conditional"+("("+m[L[a]].unit+") "):2!==k[a]&&(b+="Marginal ");0===k[a]?b+="U-matrix":1===k[a]?b+="Component Plane":2===k[a]&&(b=b+"Expected Conditional"+("("+m[0].unit+") "),b+="Component Plane");return b})}function P(a){0===k[a]?(O[a].transition().style("opacity",0),ia(a)):1===k[a]?
(O[a].transition().style("opacity",1),ja(a)):2===k[a]&&(O[a].transition().style("opacity",1),ka(a))}function ua(a,b){G[b].selectAll(".focus").remove();G[b].append("circle").attr("class","focus").attr("cx",a.x).attr("cy",a.y).style("fill","none").style("stroke","green").style("stroke-width",3).style("opacity",0).attr("r",3*g).transition().attr("r",g).style("opacity",1);m[b].unit=a.j*q+a.i}function V(a){G[a].selectAll(".focus").transition().attr("r",3*g).style("opacity",0).remove()}function da(a,b){G[b].select(".focus").transition().duration(30).attr("cx",
a.x).attr("cy",a.y).attr("r",g).style("opacity",1);m[b].unit=a.j*q+a.i}function va(){G.forEach(function(a,b){if(m[b].flag){var e=m[b].unit%q,d=Math.floor(m[b].unit/q);a.selectAll(".cpHexagon").filter(function(a){return a.i===e&&a.j===d}).each(function(a){da(a,b)})}})}function ea(a){for(var b=0;3>b;b++)a!==b&&(0===k[b]?ia(b):1===k[b]?ja(b):2===k[b]&&ka(b))}function ia(a){wa(a);la[a].style("fill",function(b,e){return ma(x[a][e])})}function wa(a){var b=m[L[a]].flag,e=[],d=0,t=0,c=0,f,n;if(!b&&fa[a])for(f=
0;f<W;f++)x[a][f]=na[a][f];else{for(f=0;f<u;f++)for(n=0;n<M;n++)if(0!==f%2||0!==n%2){if(3===n%4){var r=Math.floor(n/2)*q+Math.floor(f/2);var g=Math.ceil(n/2)*q+Math.ceil(f/2)}else r=Math.ceil(n/2)*q+Math.floor(f/2),g=Math.floor(n/2)*q+Math.ceil(f/2);var h=a;var l=L[h];var k=m[l].flag;var p=m[l].unit,l=0;if(k)l=Math.pow(I(h,r,p,0)-I(h,g,p,0),2);else if(!k)for(k=0;k<H;k++)l+=Math.pow(I(h,r,k,0)-I(h,g,k,0),2);r=Math.sqrt(l);e[n*u+f]=r;d+=r;t+=r*r;c+=1}for(f=0;f<u;f++)for(n=0;n<M;n++)if(0===f%2&&0===
n%2){for(g=r=h=0;6>g;g++)k=oa(f,n,g),-1!==k&&(r+=e[k],h+=1);r/=h;e[n*u+f]=r;d+=r;t+=r*r;c+=1}d/=c;t=Math.sqrt(t/c-Math.pow(d,2));for(f=0;f<u;f++)for(n=0;n<M;n++)if(0===f%2&&0===n%2)x[a][n*u+f]=e[n*u+f];else{for(g=r=h=0;6>g;g++)k=oa(f,n,g),-1!==k&&(r+=e[k],h+=1);r=(r+e[n*u+f])/(h+1);x[a][n*u+f]=r}for(f=0;f<W;f++)x[a][f]=(x[a][f]-d)/(4*t)+.5,0>x[a][f]&&(x[a][f]=0),1<x[a][f]&&(x[a][f]=1);if(!b&&!fa[a]){for(f=0;f<W;f++)na[a][f]=x[a][f];1!==a&&(fa[a]=!0)}}}function oa(a,b,e){switch(e){case 0:var d=a+(1===
b%4||2===b%4?1:0);var t=b-1;break;case 1:d=a+1;t=b;break;case 2:d=a+(2===b%4||3===b%4?1:0);t=b+1;break;case 3:d=a-1+(2===b%4||3===b%4?1:0);t=b+1;break;case 4:d=a-1;t=b;break;case 5:d=a-1+(1===b%4||2===b%4?1:0),t=b-1}return 0>d||d>=u||0>t||t>=M?-1:t*u+d}function ja(a){var b=L[a],e=m[b].flag,b=m[b].unit;if(1===k[a]){var d,t=Number.MIN_VALUE,c=Number.MAX_VALUE;for(d=0;d<H;d++){var f;if(e)l[a][d]=I(a,d,b,0);else if(!e){for(f=l[a][d]=0;f<H;f++)l[a][d]+=I(a,d,f,0);l[a][d]/=H}t<l[a][d]&&(t=l[a][d]);c>l[a][d]&&
(c=l[a][d])}for(d=0;d<H;d++)l[a][d]=(l[a][d]-c)/(t-c);O[a].style("fill",function(b,e){return 0===B[a]?ga(l[a][e]):pa(l[a][e])})}}function ka(a){var b=m[0].unit,e,d=Number.MIN_VALUE,c=Number.MAX_VALUE;for(e=0;e<H;e++){var g;for(g=l[a][e]=0;g<H;g++)l[a][e]+=I(0,b,g,0)*I(2,e,g,0);d<l[a][e]&&(d=l[a][e]);c>l[a][e]&&(c=l[a][e])}for(e=0;e<H;e++)l[a][e]=(l[a][e]-c)/(d-c);O[a].style("fill",function(b,e){return 0===B[a]?ga(l[a][e]):pa(l[a][e])})}function I(a,b,e,d){if(0===ba[a]){var c=b;b=e}else c=e;return 0===
B[a]?D[c][b][d]:E[c][b][d]}var c,D=w.replace(/\r/g,"").replace(/\n+$/g,"").split("\n\n");for(c=0;c<D.length;c++)for(D[c]=D[c].split("\n"),h=0;h<D[c].length;h++)for(D[c][h]=D[c][h].split(" "),w=0;w<D[c][h].length;w++)D[c][h][w]=parseFloat(D[c][h][w]);var E=Z.replace(/\r/g,"").replace(/\n+$/g,"").split("\n\n");for(c=0;c<E.length;c++)for(E[c]=E[c].split("\n"),h=0;h<E[c].length;h++)for(E[c][h]=E[c][h].split(" "),w=0;w<E[c][h].length;w++)E[c][h][w]=parseFloat(E[c][h][w]);var v=[ta,ra,sa];Z=["Attr",K.input.mode1_name,K.input.mode2_name];
var q=K.parameter.unit_num_x,J=K.parameter.unit_num_y,H=q*J,u=2*q-1,M=2*J-1,W=u*M;d3.interpolateHslLong=function(a,b){a=d3.hsl(a);b=d3.hsl(b);var e=a.h,d=a.s,c=a.l,g=b.h-e,f=b.s-d,h=b.l-c;return function(a){return d3.hsl(e+g*a,d+f*a,c+h*a).rgb().toString()}};var ma=d3.interpolateHslLong("blue","red"),ga=d3.scale.linear().domain([0,.5,1]).range(["blue","white","red"]),pa=d3.scale.linear().domain([0,1]).range(["white","black"]),xa=["Sushi data","UserAttr data"],B=[1,0,0],ba=[0,0,1],L=[1,2,1],ya=["U-Matrix",
"Component Plane"],k=[1,1,1],m=[{unit:0,flag:!1},{unit:0,flag:!1},{unit:0,flag:!1}],x=[[],[],[]],na=[[],[],[]],l=[[],[],[]],fa=[!1,!1,!1],y=(window.innerWidth-48)/3,N=window.innerHeight-140,g=d3.max([d3.min([y/((q-.5)*Math.sqrt(3)+4),2*N/(3*(J-1)+8)]),13.5]),z=g/2,y=g*(Math.sqrt(3)*(q-.5)+4),N=g*(3*(J-1)/2+4),Q=d3.hexbin().radius(g),R=[],A=[];for(c=0;c<J;c++)for(h=0;h<q;h++)R.push([g*h*1.75,g*c*1.5]),A.push({x:g*(h+c%2*.5)*Math.sqrt(3),y:g*c*1.5,unit:c*q+h});var S=d3.hexbin().radius(z),T=[],ha=[];
for(c=0;c<M;c++)for(h=0;h<u;h++)T.push([z*(h+Math.abs((c+2)%4-2)/2)*Math.sqrt(3),z*c*1.5]),ha.push({x:z*(h+Math.abs((c+2)%4-2)/2)*Math.sqrt(3),y:z*c*1.5});v.forEach(function(a,b){v[b].forEach(function(a,d){v[b][d].x=A[a.unit].x;v[b][d].y=A[a.unit].y})});K=d3.select("#chart").style("display","flex").style("flex-direction","row");var p=K.selectAll("div").data(Z).enter().append("div").attr("class","modeChart bordered").append("div").attr("id",function(a,b){return"map"+b}).text(function(a){return a+" Map"}).style("min-width",
y+"px");p.append("br");var ca=[];p.each(function(a,b){ca[b]=d3.select(this).append("div").style("width",y+"px").style("height","60px").attr("class","info dark").text("Marginal Component Plane")});var X=p.append("svg").attr("width",y).attr("height",N),F=X.append("g").attr("transform","translate("+(1+Math.sqrt(3)/2)*g+","+2*g+")"),G=[];for(c=0;3>c;c++)G.push(F.filter(function(a,b){return b===c}));p.append("br");var za=F.selectAll(".uHexagon").data(S(T)).enter().append("path").attr("class","uHexagon").style("stroke",
"black").style("stroke-width",1).style("fill",function(a,b){return ma(b/W)}).attr("d",function(a){return"M"+a.x+","+a.y+S.hexagon()}),Aa=F.selectAll(".cpHexagon").data(Q(R)).enter().append("path").attr("class","cpHexagon").style("opacity",1).style("stroke","black").style("stroke-width",1).style("fill",function(a,b){return ga(b/H*5)}).attr("d",function(a){return"M"+a.x+","+a.y+Q.hexagon()}),Ba=F.selectAll(".dot").data(A).enter().append("circle").attr("class","dot").attr("cx",function(a){return a.x}).attr("cy",
function(a){return a.y}).attr("r","1px").style("pointer-events","none");F.each(function(a,b){var e=this;100>v[b].length&&v[b].forEach(function(a){if("input"!==a.attr)return!0;d3.select(e).selectAll(".dot").filter(function(b){return b.unit===Number(a.unit)}).attr("r","4px")})});F.each(function(a,b){d3.select(this).selectAll(".label").data(v[b]).enter().append("text").attr("class","label").attr("text-anchor","middle").attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("font-family",
"Meiryo UI").attr("font-weight","bolder").attr("font-size",.5*g).attr("fill","#000").attr("stroke-width",2).attr("stroke","#FFF").attr("paint-order","stroke").text(function(a){return a.label}).style("pointer-events","none").style("display",function(a){return"input"===a.attr&&100>v[b].length?"inline":"none"})});var la=[],O=[];for(c=0;3>c;c++)la.push(F.filter(function(a,b){return b===c}).selectAll(".uHexagon")),O.push(F.filter(function(a,b){return b===c}).selectAll(".cpHexagon"));p.append("div").attr("class",
"dark").append("b").text("Color");["um","cp"].forEach(function(a,b){p.append("input").attr("id",function(b,d){return"mm"+d+a}).attr("class",function(){return a+"radio"}).attr("type","radio").attr("name",function(a,b){return"radio"+b}).property("checked",function(){return 1===b}).datum("visualizeModeInput");p.append("label").attr("for",function(b,c){return"mm"+c+a}).text(function(){return ya[b]});p.append("br")});p.filter(function(a,b){return 2===b}).append("input").attr("id","mm2ecp").attr("class",
"ecpradio").attr("type","radio").attr("name","radio2").property("disabled",!0).datum("visualizeModeInput");p.filter(function(a,b){return 2===b}).append("label").attr("for","mm2ecp").text("Expected Conditional Component Plane");p.filter(function(a,b){return 2===b}).append("br");p.filter(function(a,b){return 1===b}).append("div").attr("class","dark").append("b").text("DataSource");["sushi","attr"].forEach(function(a,b){p.filter(function(a,b){return 1===b}).append("input").attr("id","datasource"+b).attr("class",
"datasourceradio").attr("type","radio").attr("name","radios").property("checked",function(){return 0===b});p.filter(function(a,b){return 1===b}).append("label").attr("for","datasource"+b).text(function(){return xa[b]});p.filter(function(a,b){return 1===b}).append("br")});d3.selectAll(".datasourceradio").on("change",aa);var qa=[];p.each(function(a,b){d3.select(this).append("div").attr("class","dark").append("b").text("Label");qa[b]=d3.select(this).append("div")});qa.forEach(function(a,b){a.append("input").attr("class",
"attrlabel").attr("id","attrlabel"+b+"_input").attr("type","checkbox").attr("name","attrlabel"+b).property("checked",function(){return 100>v[b].length?!0:!1}).datum("input");a.append("label").attr("for","attrlabel"+b+"_input").text("Input data");a.append("br");a.selectAll(".attrlabel").on("change",function(c,d){this.checked?G[b].selectAll(".label").filter(function(a){return a.attr===c}).transition().attr("font-size",.5*g).each("start",function(){d3.select(this).style("display","inline").attr("font-size",
0).attr("x",function(a){return a.x+.01}).attr("y",function(a){return a.y+.01})}).attr("x",function(a){return a.x}).attr("y",function(a){return a.y}):G[b].selectAll(".label").filter(function(a){return a.attr===c}).transition().attr("font-size",0).each("end",function(){d3.select(this).style("display","none")});var e=[],h=[];a.selectAll(".attrlabel").filter(function(){return this.checked}).each(function(a){h.push(a)});h.forEach(function(a){v[b].forEach(function(b){a===b.attr&&e.push(Number(b.unit))})});
e=e.filter(function(a,b,c){return c.indexOf(a)===b});G[b].selectAll(".dot").transition().attr("r",function(a){return 0<=e.indexOf(a.unit)?"4px":"1px"})})});for(c=0;3>c;c++)k[c]=1,P(c);C();d3.selectAll(".umradio").on("change",function(a,b){k[b]=0;P(b);C()});d3.selectAll(".cpradio").on("change",function(a,b){k[b]=1;P(b);C()});d3.selectAll(".ecpradio").on("change",function(a){k[2]=2;P(2);m[1].flag&&(m[1].flag=!1,V(1));C()});var Y=!1,U=!1;d3.select("body").on("mouseup",function(){Y=!1});K.selectAll("div").on("mouseleave",
function(){Y=!1});d3.select("body").on("mousedown",function(){Y=!0});X.each(function(a,b){d3.select(this).selectAll(".cpHexagon").on("mouseover",function(a){Y&&m[b].flag&&(da(a,b),ea(b),C(),d3.event.preventDefault())})});X.each(function(a,b){d3.select(this).selectAll(".cpHexagon").on("mousedown",function(a){m[b].flag?m[b].unit===a.j*q+a.i?U=!0:(U=!1,da(a,b),C()):(U=!1,m[b].flag=!0,ua(a,b),C());0===b&&(0===B[1]&&(d3.selectAll(".datasourceradio").property("checked",function(a,b){return 1===b}),aa(void 0,
1)),m[2].flag&&(m[2].flag=!1,V(2)),d3.select("#mm2ecp").property("disabled",!1));1===b&&2===k[2]&&(k[2]=1,p.filter(function(a,b){return 2===b}).selectAll("input").property("checked",function(a,b){return 1===b}),d3.select("#mm2ecp").property("disabled",!0));2===b&&(1===B[1]&&(d3.selectAll(".datasourceradio").property("checked",function(a,b){return 0===b}),aa(void 0,0)),m[0].flag&&(m[0].flag=!1,V(0)));ea(b);C();d3.event.preventDefault()});d3.select(this).selectAll(".cpHexagon").on("click",function(a){m[b].flag&&
m[b].unit===a.j*q+a.i&&U&&(U=!1,m[b].flag=!1,V(b),0===b&&(2===k[2]&&(k[2]=1,p.filter(function(a,b){return 2===b}).selectAll("input").property("checked",function(a,b){return 1===b})),d3.select("#mm2ecp").property("disabled",!0)),1===b&&1===B[1]&&d3.select("#mm2ecp").property("disabled",!1),ea(b),C(),d3.event.preventDefault())})});d3.select(window).on("resize",function(a){var b;y=(window.innerWidth-48)/3;N=window.innerHeight-140;g=d3.max([d3.min([y/((q-.5)*Math.sqrt(3)+4),2*N/(3*(J-1)+8)]),13.5]);z=
g/2;y=g*(Math.sqrt(3)*(q-.5)+4);N=g*(3*(J-1)/2+4);Q=d3.hexbin().radius(g);R=[];A=[];for(a=0;a<J;a++)for(b=0;b<q;b++)R.push([g*b*1.75,g*a*1.5]),A.push({x:g*(b+a%2*.5)*Math.sqrt(3),y:g*a*1.5,unit:a*q+b});S=d3.hexbin().radius(z);T=[];ha=[];for(a=0;a<M;a++)for(b=0;b<u;b++)T.push([z*(b+Math.abs((a+2)%4-2)/2)*Math.sqrt(3),z*a*1.5]),ha.push({x:z*(b+Math.abs((a+2)%4-2)/2)*Math.sqrt(3),y:z*a*1.5});p.style("min-width",y+"px");ca.forEach(function(a){a.style("width",y+"px")});F.attr("transform","translate("+
(1+Math.sqrt(3)/2)*g+","+2*g+")");X.attr("width",y).attr("height",N);Aa.data(Q(R)).attr("d",function(a){return"M"+a.x+","+a.y+Q.hexagon()});za.data(S(T)).attr("d",function(a){return"M"+a.x+","+a.y+S.hexagon()});Ba.data(A).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y});F.each(function(a,b){d3.select(this).selectAll(".label").attr("x",function(a){return A[a.unit].x}).attr("y",function(a){return A[a.unit].y}).attr("font-size",.5*g)});v.forEach(function(a,b){v[b].forEach(function(a,
c){v[b][c].x=A[a.unit].x;v[b][c].y=A[a.unit].y})});va()})})})();